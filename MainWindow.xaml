<?xml version="1.0" encoding="utf-8"?>
<Window
    x:Class="KAIROS.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:KAIROS"
    xmlns:vm="using:KAIROS.ViewModels"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d"
    Title="KAIROS - AI Chat Assistant">

    <Window.SystemBackdrop>
        <MicaBackdrop />
    </Window.SystemBackdrop>

    <Window.KeyboardAccelerators>
        <!-- Ctrl+N for New Conversation -->
        <KeyboardAccelerator Key="N" Modifiers="Control" Invoked="NewConversation_Invoked"/>
        <!-- Ctrl+H for History -->
        <KeyboardAccelerator Key="H" Modifiers="Control" Invoked="History_Invoked"/>
        <!-- Ctrl+E for Export -->
        <KeyboardAccelerator Key="E" Modifiers="Control" Invoked="Export_Invoked"/>
        <!-- Ctrl+, for Settings -->
        <KeyboardAccelerator Key="OemComma" Modifiers="Control" Invoked="Settings_Invoked"/>
        <!-- F1 for Help -->
        <KeyboardAccelerator Key="F1" Invoked="Help_Invoked"/>
    </Window.KeyboardAccelerators>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <Grid Grid.Row="0" 
              Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
              Padding="20,16"
              BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
              BorderThickness="0,0,0,1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <StackPanel Grid.Column="0" Spacing="4">
                <TextBlock Text="{x:Bind ViewModel.CurrentConversationTitle, Mode=OneWay}"
                           Style="{StaticResource TitleTextBlockStyle}"
                           FontWeight="SemiBold"/>
                <TextBlock Text="{x:Bind ViewModel.StatusMessage, Mode=OneWay}"
                           Style="{StaticResource CaptionTextBlockStyle}"
                           Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
            </StackPanel>

            <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8">
                <Button Click="OpenHelp_Click"
                        ToolTipService.ToolTip="Help & Tips">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE897;" FontSize="16"/>
                        <TextBlock Text="Help"/>
                    </StackPanel>
                </Button>
                <Button Click="OpenHistory_Click"
                        IsEnabled="{x:Bind ViewModel.IsModelReady, Mode=OneWay}"
                        ToolTipService.ToolTip="View Conversation History">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE81C;" FontSize="16"/>
                        <TextBlock Text="History"/>
                    </StackPanel>
                </Button>
                <Button Click="ExportConversation_Click"
                        IsEnabled="{x:Bind ViewModel.IsModelReady, Mode=OneWay}"
                        ToolTipService.ToolTip="Export Conversation to Markdown">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE74E;" FontSize="16"/>
                        <TextBlock Text="Export"/>
                    </StackPanel>
                </Button>
                <Button Click="OpenSettings_Click"
                        ToolTipService.ToolTip="Settings">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE713;" FontSize="16"/>
                        <TextBlock Text="Settings"/>
                    </StackPanel>
                </Button>
                <Button Click="SelectModel_Click"
                        ToolTipService.ToolTip="Change AI Model">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE8F4;" FontSize="16"/>
                        <TextBlock Text="Model"/>
                    </StackPanel>
                </Button>
                <Button Command="{x:Bind ViewModel.NewConversationCommand}"
                        ToolTipService.ToolTip="New Conversation">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE710;" FontSize="16"/>
                        <TextBlock Text="New Chat"/>
                    </StackPanel>
                </Button>
            </StackPanel>
        </Grid>

        <!-- Chat Messages Area -->
        <ScrollViewer Grid.Row="1" 
                      x:Name="ChatScrollViewer"
                      Padding="20"
                      VerticalScrollBarVisibility="Auto">
            <ItemsControl ItemsSource="{x:Bind ViewModel.Messages, Mode=OneWay}">
                <ItemsControl.ItemTemplate>
                    <DataTemplate x:DataType="vm:ChatMessageViewModel">
                        <Grid Margin="0,0,0,20">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <!-- User Message (Right aligned) -->
                            <Grid Grid.Column="1"
                                  Grid.ColumnSpan="2"
                                  HorizontalAlignment="Right"
                                  MaxWidth="600"
                                  Visibility="{x:Bind IsUser, Mode=OneWay}">
                                <Border Background="{ThemeResource AccentFillColorDefaultBrush}"
                                        CornerRadius="12,12,4,12"
                                        Padding="16,12">
                                    <TextBlock Text="{x:Bind Content, Mode=OneWay}"
                                               Foreground="White"
                                               TextWrapping="Wrap"
                                               IsTextSelectionEnabled="True"/>
                                </Border>
                            </Grid>

                            <!-- Assistant Message (Left aligned) -->
                            <Grid Grid.Column="0"
                                  Grid.ColumnSpan="2"
                                  HorizontalAlignment="Left"
                                  MaxWidth="600">
                                <Grid.Visibility>
                                    <Binding Path="IsUser" Mode="OneWay">
                                        <Binding.Converter>
                                            <local:InverseBoolToVisibilityConverter/>
                                        </Binding.Converter>
                                    </Binding>
                                </Grid.Visibility>

                                <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                                        BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                        BorderThickness="1"
                                        CornerRadius="12,12,12,4"
                                        Padding="16,12">
                                    <StackPanel Spacing="8">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                                            <FontIcon Glyph="&#xE8F4;" 
                                                      FontSize="16"
                                                      Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}"
                                                      Margin="0,0,8,0"/>
                                            <TextBlock Grid.Column="1"
                                                       Text="AI Assistant"
                                                       Style="{StaticResource CaptionTextBlockStyle}"
                                                       FontWeight="SemiBold"
                                                       Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}"/>
                                            <Button Grid.Column="2"
                                                    Click="CopyMessage_Click"
                                                    Tag="{x:Bind Content, Mode=OneWay}"
                                                    Style="{StaticResource SubtleButtonStyle}"
                                                    Padding="8,4"
                                                    ToolTipService.ToolTip="Copy to clipboard">
                                                <FontIcon Glyph="&#xE8C8;" FontSize="14"/>
                                            </Button>
                                        </Grid>
                                        <TextBlock Text="{x:Bind Content, Mode=OneWay}"
                                                   TextWrapping="Wrap"
                                                   IsTextSelectionEnabled="True"/>
                                    </StackPanel>
                                </Border>
                            </Grid>
                        </Grid>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>

        <!-- Loading Indicator -->
        <ProgressBar Grid.Row="1"
                     IsIndeterminate="True"
                     VerticalAlignment="Bottom"
                     Visibility="{x:Bind ViewModel.IsLoading, Mode=OneWay}"/>

        <!-- Download Progress -->
        <Grid Grid.Row="1"
              Background="{ThemeResource AcrylicInAppFillColorDefaultBrush}"
              Visibility="{x:Bind ViewModel.IsDownloading, Mode=OneWay}">
            <StackPanel HorizontalAlignment="Center"
                        VerticalAlignment="Center"
                        Spacing="16"
                        MaxWidth="400">
                <FontIcon Glyph="&#xE896;" 
                          FontSize="48"
                          Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}"/>
                <TextBlock Text="Downloading Model..."
                           Style="{StaticResource TitleTextBlockStyle}"
                           HorizontalAlignment="Center"/>
                <ProgressBar Value="{x:Bind ViewModel.DownloadProgress, Mode=OneWay}"
                             Maximum="100"
                             Width="300"/>
                <TextBlock Text="{x:Bind ViewModel.StatusMessage, Mode=OneWay}"
                           Style="{StaticResource CaptionTextBlockStyle}"
                           HorizontalAlignment="Center"
                           Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
            </StackPanel>
        </Grid>

        <!-- Input Area -->
        <Grid Grid.Row="2" 
              Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
              Padding="20,16"
              BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
              BorderThickness="0,1,0,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <TextBox x:Name="InputTextBox"
                     Grid.Column="0"
                     Text="{x:Bind ViewModel.UserInput, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                     PlaceholderText="Type your message here... (Enter to send, Shift+Enter for new line)"
                     AcceptsReturn="True"
                     TextWrapping="Wrap"
                     MaxHeight="120"
                     VerticalAlignment="Center"
                     Margin="0,0,12,0"
                     IsEnabled="{x:Bind ViewModel.IsModelReady, Mode=OneWay}">
                <TextBox.KeyboardAccelerators>
                    <KeyboardAccelerator Key="Enter" 
                                         Invoked="SendMessage_Invoked"/>
                </TextBox.KeyboardAccelerators>
            </TextBox>

            <StackPanel Grid.Column="1" 
                        Orientation="Horizontal" 
                        Spacing="8"
                        VerticalAlignment="Center">
                <Button Command="{x:Bind ViewModel.StopGenerationCommand}"
                        Visibility="{x:Bind ViewModel.IsLoading, Mode=OneWay}"
                        Style="{StaticResource AccentButtonStyle}"
                        ToolTipService.ToolTip="Stop Generation">
                    <FontIcon Glyph="&#xE71A;" FontSize="16"/>
                </Button>

                <Button Command="{x:Bind ViewModel.SendMessageCommand}"
                        Style="{StaticResource AccentButtonStyle}"
                        ToolTipService.ToolTip="Send Message (Enter)">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE724;" FontSize="16"/>
                        <TextBlock Text="Send"/>
                    </StackPanel>
                </Button>
            </StackPanel>
        </Grid>
    </Grid>
</Window>
